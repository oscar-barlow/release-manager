name: CI

on:
  push:
    branches-ignore:
      - main
      - 'dependabot/**'
  pull_request:
    branches: [main]

jobs:
  test:
    name: Run Tests (${{ github.event_name }})
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run pytest
        run: uv run pytest

  type-check:
    name: Type Check (${{ github.event_name }})
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v2

      - name: Install dependencies
        run: |
          uv venv
          uv pip install -e ".[dev]"

      - name: Run mypy
        run: uv run mypy

  build:
    name: Build Container (${{ github.event_name }})
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        run: docker build -t release-manager:ci .

  publish:
    name: Publish Container Tag (${{ github.event_name }})
    runs-on: ubuntu-latest
    needs:
      - test
      - build
      - type-check
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine next image tag
        id: tag
        env:
          IMAGE_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail
          export GH_TOKEN
          DATE_TAG=$(date -u '+%Y-%-m-%-d')
          REPO_LC=$(echo "${IMAGE_REPO}" | tr '[:upper:]' '[:lower:]')
          PACKAGE_NAME=$(echo "${IMAGE_REPO}" | awk -F'/' '{print tolower($2)}')
          TAGS=$(gh api --paginate "/users/${OWNER}/packages/container/${PACKAGE_NAME}/versions" --jq '.[].metadata.container.tags[]' 2>/dev/null || true)
          if [ -z "${TAGS}" ]; then
            TAGS=$(gh api --paginate "/orgs/${OWNER}/packages/container/${PACKAGE_NAME}/versions" --jq '.[].metadata.container.tags[]' 2>/dev/null || true)
          fi
          TAGS=$(echo "${TAGS}" | tr ' ' '\n' | sort -u)
          LAST_NUM=0
          if [ -n "${TAGS}" ]; then
            while IFS= read -r tag; do
              if [[ "$tag" == "${DATE_TAG}."* ]]; then
                num="${tag##*.}"
                if [[ "$num" =~ ^[0-9]+$ ]] && [ "$num" -gt "$LAST_NUM" ]; then
                  LAST_NUM="$num"
                fi
              fi
            done <<< "${TAGS}"
          fi
          NEXT_NUM=$((LAST_NUM + 1))
          NEXT_TAG="${DATE_TAG}.${NEXT_NUM}"
          echo "next_tag=${NEXT_TAG}" >> "$GITHUB_OUTPUT"
          echo "image_repo=${REPO_LC}" >> "$GITHUB_OUTPUT"

      - name: Build and push image
        env:
          IMAGE_REPO: ${{ steps.tag.outputs.image_repo }}
          NEXT_TAG: ${{ steps.tag.outputs.next_tag }}
        run: |
          set -euo pipefail
          IMAGE="ghcr.io/${IMAGE_REPO}"
          docker build -t "${IMAGE}:${NEXT_TAG}" .
          docker push "${IMAGE}:${NEXT_TAG}"
